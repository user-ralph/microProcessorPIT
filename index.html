<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />

    <title>Optimized Solid Waste Segregation Bin</title>
  </head>
  <body style="background-color: #fefae0">
    <!-- Welcome Message Below -->
    <h2 class="headerTitle">Optimized Solid Waste Segregation Bin</h2>
    <p class="welcomeMessage">
      Welcome Admin! Welcome to the monitoring page of your segregation bins
    </p>

    <div class="card webContainerFixtureA">
      <div class="card-body webMessageA">
        <i class="bx bx-chevrons-down bx-fade-down"></i>
        Access one of available bins here.
        <i class="bx bx-chevrons-down bx-fade-down"></i>
      </div>
    </div>

    <!-- Web Components Below -->

    <div class="card webContainerFixtureB">
      <div class="card-header">
        Trash Bin A <i class="bx bx-trash bx-flashing"></i>
      </div>
      <div class="card-body">
        <table
          class="table table-hover table-bordered table-sm table-responsive"
        >
          <thead>
            <tr>
              <th scope="col">Bin No.</th>
              <th scope="col">Class</th>
              <th scope="col">Status</th>
              <th scope="col">Quantity</th>
            </tr>
          </thead>
          <tbody>
            <tr id="rowBiodegradable">
              <th>1</th>
              <td>Biodegradable</td>
              <td id="biodegradableStatus">Otto</td>
              <td id="biodegradableCount">@mdo</td>
            </tr>
            <tr id="rowNonBiodegradable">
              <th>2</th>
              <td>Non-Biodegradable</td>
              <td id="nonBiodegradableStatus">Thornton</td>
              <td id="nonBiodegradableCount">@fat</td>
            </tr>
            <tr id="rowRecyclable">
              <th>3</th>
              <td>Recyclable</td>
              <td id="recyclableStatus">Otto</td>
              <td id="recyclableCount">@mdo</td>
            </tr>
          </tbody>
        </table>

        <div>
          <canvas id="myChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div
      class="modal fade"
      id="staticBackdrop"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-fullscreen-xxl-down">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #ebebd3">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Personnel Login
            </h1>
          </div>
          <div class="modal-body" style="background-color: #ebebd3">
            <!-- Image Carousel -->

            <div class="card" style="background-color: #ebebd3">
              <p style="align-self: center">
                <iframe
                  width="626"
                  height="321"
                  src="https://www.youtube.com/embed/-qRwcAfccbI"
                  title="USTP: Advancing A Sustainable Future"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allowfullscreen
                ></iframe>
              </p>
            </div>

            <form class="login-form" id="loginForm">
              <div class="input-group mb-3" style="margin-top: 8px">
                <span class="input-group-text" id="basic-addon1"
                  ><i class="bx bx-envelope"></i
                ></span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Email"
                  id="userEmail"
                  required
                />
              </div>

              <div class="input-group mb-3">
                <span class="input-group-text" id="basic-addon1"
                  ><i class="bx bx-key"></i
                ></span>
                <input
                  type="password"
                  placeholder="Password"
                  id="userPassword"
                  required
                  aria-label="Password"
                  aria-describedby="basic-addon1"
                  style="width: 80.5em; padding-left: 14px; border: none"
                />
              </div>

              <div class="d-grid gap-2">
                <button
                  class="submit btn"
                  type="button"
                  id="userSubmit-button"
                  style="background-color: #606c38; color: #ebebd3"
                >
                  Login
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="footerContent">
      <div class="card webContainerFixtureC">
        <div class="card-body">
          <div class="accordion accordion-flush" id="accordionFlushExample">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#flush-collapseOne"
                  aria-expanded="false"
                  aria-controls="flush-collapseOne"
                >
                  Logout
                </button>
              </h2>
              <div
                id="flush-collapseOne"
                class="accordion-collapse collapse"
                data-bs-parent="#accordionFlushExample"
              >
                <div class="accordion-body">
                  Do you wish to log out of this page?
                  <button
                    type="button"
                    class="btn btn-outline-danger LogOutButton"
                    id="logOutButton"
                  >
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAsiuLpjDF_pW-x95hAelpaL5hf-v-o7q0",
        authDomain: "fir-test-d61b0.firebaseapp.com",
        databaseURL:
          "https://fir-test-d61b0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fir-test-d61b0",
        storageBucket: "fir-test-d61b0.appspot.com",
        messagingSenderId: "333541744394",
        appId: "1:333541744394:web:4d104a5ee222d56b2f24f3",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);

      // Function to retrieve and display data
      function updateBinData() {
        const biodegradableRef = ref(database, "classification/biodegradable");
        const nonBiodegradableRef = ref(
          database,
          "classification/non-biodegradable"
        );
        const recyclableRef = ref(database, "classification/recyclable");

        onValue(biodegradableRef, (snapshot) => {
          const data = snapshot.val();
          document.getElementById("biodegradableCount").innerText = data;
          const biodegradableStatus = document.getElementById(
            "biodegradableStatus"
          );
          const rowBiodegradable = document.getElementById("rowBiodegradable");
          if (data < 31) {
            biodegradableStatus.innerText = "Normal";
            biodegradableStatus.style.color = "#283618";
            biodegradableStatus.style.fontWeight = "bold";
            rowBiodegradable.style.backgroundColor = "";
          } else {
            biodegradableStatus.innerText = "Overflow";
            biodegradableStatus.style.color = "#e76f51";
            biodegradableStatus.style.fontWeight = "bold";
            rowBiodegradable.style.backgroundColor = "#edede9";
          }
        });

        onValue(nonBiodegradableRef, (snapshot) => {
          const data = snapshot.val();
          document.getElementById("nonBiodegradableCount").innerText = data;
          const nonBiodegradableStatus = document.getElementById(
            "nonBiodegradableStatus"
          );
          const rowNonBiodegradable = document.getElementById(
            "rowNonBiodegradable"
          );
          if (data < 31) {
            nonBiodegradableStatus.innerText = "Normal";
            nonBiodegradableStatus.style.color = "#283618";
            nonBiodegradableStatus.style.fontWeight = "bold";
            rowNonBiodegradable.style.backgroundColor = "";
          } else {
            nonBiodegradableStatus.innerText = "Overflow";
            nonBiodegradableStatus.style.color = "#e76f51";
            nonBiodegradableStatus.style.fontWeight = "bold";
            rowNonBiodegradable.style.backgroundColor = "#edede9";
          }
        });

        onValue(recyclableRef, (snapshot) => {
          const data = snapshot.val();
          document.getElementById("recyclableCount").innerText = data;
          const recyclableStatus = document.getElementById("recyclableStatus");
          const rowRecyclable = document.getElementById("rowRecyclable");
          if (data < 31) {
            recyclableStatus.innerText = "Normal";
            recyclableStatus.style.color = "#283618";
            recyclableStatus.style.fontWeight = "bold";
            rowRecyclable.style.backgroundColor = "";
          } else {
            recyclableStatus.innerText = "Overflow";
            recyclableStatus.style.color = "#e76f51";
            recyclableStatus.style.fontWeight = "bold";
            rowRecyclable.style.backgroundColor = "#edede9";
          }
        });
      }

      // Part of the code to authenticate the user login
      document.addEventListener("DOMContentLoaded", function () {
        var myModal = new bootstrap.Modal(
          document.getElementById("staticBackdrop"),
          {
            keyboard: false,
          }
        );
        myModal.show();
        updateBinData(); // Call the function to update data on page load
      });

      document
        .getElementById("userSubmit-button")
        .addEventListener("click", function () {
          const email = document.getElementById("userEmail").value;
          const password = document.getElementById("userPassword").value;

          signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              // Signed in
              alert("Login successful");
              const myModal = bootstrap.Modal.getInstance(
                document.getElementById("staticBackdrop")
              );
              myModal.hide();
              updateBinData(); // Update data after successful login
            })
            .catch((error) => {
              const errorCode = error.code;
              const errorMessage = error.message;
              alert("Wrong email or password. Please try again.");
            });
        });

      document
        .getElementById("logOutButton")
        .addEventListener("click", function () {
          signOut(auth)
            .then(() => {
              alert("Logout successful");
              location.reload(); // Refresh the page
            })
            .catch((error) => {
              alert("An error occurred during logout. Please try again.");
            });
        });

      // Use for Graphics
      const ctx = document.getElementById("myChart");
      let chart;

      function updateChart(data) {
        if (chart) {
          chart.destroy();
        }
        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Biodegradable", "Non-Biodegradable", "Recyclable"],
            datasets: [
              {
                label: "Quantity",
                data: [
                  data.biodegradable,
                  data.nonBiodegradable,
                  data.recyclable,
                ],
                borderWidth: 1,
                backgroundColor: ["#e76f51", "#f4a261", "#2a9d8f"],
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      function fetchAndUpdateChartData() {
        const biodegradableRef = ref(database, "classification/biodegradable");
        const nonBiodegradableRef = ref(
          database,
          "classification/non-biodegradable"
        );
        const recyclableRef = ref(database, "classification/recyclable");

        onValue(biodegradableRef, (snapshot) => {
          const biodegradableData = snapshot.val();
          onValue(nonBiodegradableRef, (snapshot) => {
            const nonBiodegradableData = snapshot.val();
            onValue(recyclableRef, (snapshot) => {
              const recyclableData = snapshot.val();
              updateChart({
                biodegradable: biodegradableData,
                nonBiodegradable: nonBiodegradableData,
                recyclable: recyclableData,
              });
            });
          });
        });
      }

      // Fetch chart data initially and on updates
      fetchAndUpdateChartData();
    </script>
  </body>
</html>
